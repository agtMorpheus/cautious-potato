# Docker Configurations for Render.com

This directory contains Docker configurations for deploying the application to Render.com.

## Files

### Dockerfile.php
Main application container with PHP 8.1 and Apache.

**Features:**
- PHP 8.1 with Apache web server
- PDO, PDO_MySQL, MySQLi extensions
- Apache mod_rewrite and headers enabled
- Health check endpoint configured
- Automatic permissions setup

**Usage:**
```bash
docker build -f docker/Dockerfile.php -t abrechnung-app .
docker run -p 80:80 abrechnung-app
```

### Dockerfile.mysql
MySQL 8.0 database container with automatic schema initialization.

**Features:**
- MySQL 8.0
- Automatic database creation
- Schema initialization on first startup
- Configured for Render.com environment

**Usage:**
```bash
docker build -f docker/Dockerfile.mysql -t contract-db .
docker run -p 3306:3306 contract-db
```

### apache-config.conf
Apache virtual host configuration.

**Features:**
- Document root at `/var/www/html`
- .htaccess support enabled
- Security headers configured
- API directory optimization
- Custom error logging

**Security Headers:**
- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- Referrer-Policy: strict-origin-when-cross-origin

## Local Testing

Test the Docker setup locally before deploying to Render:

```bash
# Build images
docker build -f docker/Dockerfile.php -t abrechnung-app .
docker build -f docker/Dockerfile.mysql -t contract-db .

# Run database
docker run -d --name db \
  -e MYSQL_ROOT_PASSWORD=root \
  -e MYSQL_DATABASE=contract_manager \
  -e MYSQL_USER=contract_user \
  -e MYSQL_PASSWORD=password \
  -p 3306:3306 \
  contract-db

# Wait for database to initialize
sleep 30

# Run application
docker run -d --name app \
  -e DB_HOST=host.docker.internal \
  -e DB_NAME=contract_manager \
  -e DB_USER=contract_user \
  -e DB_PASS=password \
  -e APP_ENV=development \
  -e APP_DEBUG=true \
  -p 8080:80 \
  abrechnung-app

# Test
curl http://localhost:8080/api/health
```

## Render.com Deployment

These Docker configurations are automatically used by Render when deploying via the `render.yaml` blueprint.

The deployment process:
1. Render reads `render.yaml`
2. Builds Docker images using these Dockerfiles
3. Deploys containers with environment variables
4. Sets up networking between services

## Environment Variables

The following environment variables are required:

**Database Container:**
- `MYSQL_ROOT_PASSWORD` - Root password (auto-generated by Render)
- `MYSQL_DATABASE` - Database name
- `MYSQL_USER` - Database user
- `MYSQL_PASSWORD` - User password (auto-generated by Render)

**Application Container:**
- `DB_HOST` - Database hostname
- `DB_NAME` - Database name
- `DB_USER` - Database user
- `DB_PASS` - Database password
- `APP_ENV` - Application environment (production/development)
- `APP_DEBUG` - Debug mode (true/false)
- `CORS_ORIGIN` - Allowed CORS origins
- Plus other app-specific variables (see render.yaml)

## Customization

### Changing PHP Version

Edit `Dockerfile.php`:
```dockerfile
FROM php:8.2-apache  # or php:8.3-apache
```

### Adding PHP Extensions

Edit `Dockerfile.php`:
```dockerfile
RUN docker-php-ext-install pdo pdo_mysql mysqli zip gd
```

### Changing MySQL Version

Edit `Dockerfile.mysql`:
```dockerfile
FROM mysql:8.1  # or mariadb:10.11
```

### Custom Apache Configuration

Edit `apache-config.conf` to add:
- Custom headers
- Rewrite rules
- Security policies
- Performance optimizations

## Troubleshooting

### Build Fails
- Check Dockerfile syntax
- Verify all COPY paths exist
- Check for missing dependencies

### Container Won't Start
- Check environment variables
- Review container logs: `docker logs <container>`
- Verify ports are available

### Health Check Fails
- Verify `/api/health` endpoint works
- Check Apache is running
- Review PHP error logs

### Database Connection Issues
- Verify database is running
- Check network connectivity
- Confirm credentials are correct
- Check database initialization completed

## Production Considerations

1. **Security:**
   - Never commit secrets in Dockerfiles
   - Use environment variables for all sensitive data
   - Keep base images updated

2. **Performance:**
   - Minimize image layers
   - Use .dockerignore to exclude unnecessary files
   - Enable PHP OPcache for production

3. **Monitoring:**
   - Configure health checks
   - Set up logging
   - Monitor resource usage

4. **Backups:**
   - Regular database backups
   - Export data before major changes
   - Test restore procedures

## Additional Resources

- [Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
- [Render Docker Deployments](https://render.com/docs/docker)
- [PHP Docker Images](https://hub.docker.com/_/php)
- [MySQL Docker Images](https://hub.docker.com/_/mysql)
