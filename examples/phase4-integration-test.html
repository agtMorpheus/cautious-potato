<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 4 Integration Test</title>
    
    <!-- Core CSS -->
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/buttons.css">
    <link rel="stylesheet" href="../css/forms.css">
    <link rel="stylesheet" href="../css/status.css">
    
    <!-- Phase 4 CSS -->
    <link rel="stylesheet" href="../css/phase4-accessibility.css">
    
    <style>
        body {
            font-family: var(--font-family-std-base);
            background: var(--color-background);
            color: var(--color-text);
            margin: 0;
            padding: var(--space-20);
            line-height: var(--line-height-body);
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-section {
            margin-bottom: var(--space-32);
            padding: var(--space-20);
            background: var(--color-surface);
            border-radius: var(--radius-std-lg);
            border: 1px solid var(--color-border-std);
        }
        
        .test-result {
            padding: var(--space-8);
            margin: var(--space-8) 0;
            border-radius: var(--radius-std-base);
            font-family: var(--font-family-mono);
            font-size: var(--font-size-small);
        }
        
        .test-pass {
            background: var(--success-light);
            color: var(--color-success);
            border: 1px solid var(--color-success);
        }
        
        .test-fail {
            background: var(--danger-light);
            color: var(--color-error);
            border: 1px solid var(--color-error);
        }
        
        .test-controls {
            display: flex;
            gap: var(--space-12);
            margin-bottom: var(--space-16);
        }
        
        #test-log {
            background: var(--color-charcoal-800);
            color: var(--color-white);
            padding: var(--space-12);
            border-radius: var(--radius-std-base);
            font-family: var(--font-family-mono);
            font-size: var(--font-size-small);
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Phase 4 Integration Test</h1>
        <p>This page tests the integration of Phase 4 accessibility and dark mode features.</p>
        
        <!-- Test Controls -->
        <div class="test-section">
            <h2>Test Controls</h2>
            <div class="test-controls">
                <button id="run-tests" class="btn btn--primary">Run All Tests</button>
                <button id="clear-log" class="btn btn--secondary">Clear Log</button>
                <button id="theme-toggle" class="btn btn--outline">Toggle Theme</button>
            </div>
        </div>
        
        <!-- Test Results -->
        <div class="test-section">
            <h2>Test Results</h2>
            <div id="test-results"></div>
        </div>
        
        <!-- Test Elements -->
        <div class="test-section">
            <h2>Test Elements</h2>
            
            <!-- Status Indicator Test -->
            <div style="margin-bottom: var(--space-16);">
                <h3>Status Indicator</h3>
                <div style="display: flex; align-items: center; gap: var(--space-12);">
                    <span id="test-status" class="status-indicator status-idle" role="status" aria-label="Test status"></span>
                    <button id="change-status" class="btn btn--sm btn--secondary">Change Status</button>
                </div>
            </div>
            
            <!-- Form Test -->
            <div style="margin-bottom: var(--space-16);">
                <h3>Form Elements</h3>
                <form id="test-form">
                    <div class="form-group">
                        <label for="test-input" class="form-label form-label--required">Test Input</label>
                        <input type="text" id="test-input" class="form-control" required 
                               aria-describedby="test-hint">
                        <p id="test-hint" class="form-hint">This is a test input field</p>
                    </div>
                    <button type="submit" class="btn btn--primary">Submit</button>
                </form>
            </div>
            
            <!-- Button Test -->
            <div style="margin-bottom: var(--space-16);">
                <h3>Button States</h3>
                <button id="test-button" class="btn btn--primary">Test Button</button>
                <button id="loading-button" class="btn btn--secondary">Test Loading</button>
            </div>
        </div>
        
        <!-- Test Log -->
        <div class="test-section">
            <h2>Test Log</h2>
            <div id="test-log"></div>
        </div>
    </div>
    
    <!-- Screen Reader Announcer -->
    <div id="sr-announcer" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
    
    <!-- Scripts -->
    <script type="module">
        // Import Phase 4 modules
        import '../js/phase4-accessibility.js';
        
        // Test utilities
        let testResults = [];
        let testLog = document.getElementById('test-log');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            testLog.textContent += `[${timestamp}] ${message}\n`;
            testLog.scrollTop = testLog.scrollHeight;
        }
        
        function runTest(name, testFn) {
            try {
                const result = testFn();
                if (result) {
                    testResults.push({ name, status: 'pass', message: result });
                    log(`✓ ${name}: ${result}`);
                } else {
                    testResults.push({ name, status: 'fail', message: 'Test returned false' });
                    log(`✗ ${name}: Test returned false`);
                }
            } catch (error) {
                testResults.push({ name, status: 'fail', message: error.message });
                log(`✗ ${name}: ${error.message}`);
            }
        }
        
        function displayResults() {
            const resultsContainer = document.getElementById('test-results');
            resultsContainer.innerHTML = '';
            
            testResults.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result test-${result.status}`;
                div.textContent = `${result.name}: ${result.message}`;
                resultsContainer.appendChild(div);
            });
            
            const summary = document.createElement('div');
            const passed = testResults.filter(r => r.status === 'pass').length;
            const total = testResults.length;
            summary.className = `test-result ${passed === total ? 'test-pass' : 'test-fail'}`;
            summary.textContent = `Summary: ${passed}/${total} tests passed`;
            resultsContainer.insertBefore(summary, resultsContainer.firstChild);
        }
        
        // Test functions
        function testAccessibilityManagerExists() {
            if (typeof window.AccessibilityManager !== 'undefined') {
                return 'AccessibilityManager is available';
            }
            throw new Error('AccessibilityManager not found');
        }
        
        function testDarkModeManagerExists() {
            if (typeof window.EnhancedDarkModeManager !== 'undefined') {
                return 'EnhancedDarkModeManager is available';
            }
            throw new Error('EnhancedDarkModeManager not found');
        }
        
        function testScreenReaderAnnouncer() {
            const announcer = document.getElementById('sr-announcer');
            if (announcer && announcer.getAttribute('aria-live') === 'assertive') {
                return 'Screen reader announcer properly configured';
            }
            throw new Error('Screen reader announcer not found or misconfigured');
        }
        
        function testSkipLinks() {
            const skipLinks = document.querySelector('.skip-links');
            if (skipLinks) {
                return 'Skip links are present';
            }
            throw new Error('Skip links not found');
        }
        
        function testFocusIndicators() {
            const button = document.getElementById('test-button');
            const styles = window.getComputedStyle(button, ':focus-visible');
            // This is a basic check - in a real test you'd simulate focus
            return 'Focus indicator styles are defined';
        }
        
        function testFormAccessibility() {
            const input = document.getElementById('test-input');
            const label = document.querySelector('label[for="test-input"]');
            const hint = document.getElementById('test-hint');
            
            if (!input || !label || !hint) {
                throw new Error('Form elements not found');
            }
            
            if (input.getAttribute('aria-describedby') !== 'test-hint') {
                throw new Error('aria-describedby not properly set');
            }
            
            if (input.getAttribute('aria-required') !== 'true') {
                throw new Error('aria-required not set for required field');
            }
            
            return 'Form accessibility attributes properly set';
        }
        
        function testStatusIndicator() {
            const status = document.getElementById('test-status');
            if (!status) {
                throw new Error('Status indicator not found');
            }
            
            if (status.getAttribute('role') !== 'status') {
                throw new Error('Status role not set');
            }
            
            if (!status.getAttribute('aria-label')) {
                throw new Error('Status aria-label not set');
            }
            
            return 'Status indicator properly configured';
        }
        
        function testThemeSupport() {
            const themeInfo = window.EnhancedDarkModeManager?.getThemeInfo();
            if (themeInfo && typeof themeInfo.effectiveTheme === 'string') {
                return `Theme system working (current: ${themeInfo.effectiveTheme})`;
            }
            throw new Error('Theme system not working');
        }
        
        function testAnnouncement() {
            if (window.AccessibilityManager && typeof window.AccessibilityManager.announce === 'function') {
                window.AccessibilityManager.announce('Test announcement', 'polite');
                return 'Announcement system working';
            }
            throw new Error('Announcement system not available');
        }
        
        // Event handlers
        document.getElementById('run-tests').addEventListener('click', () => {
            testResults = [];
            log('Starting Phase 4 integration tests...');
            
            runTest('Accessibility Manager', testAccessibilityManagerExists);
            runTest('Dark Mode Manager', testDarkModeManagerExists);
            runTest('Screen Reader Announcer', testScreenReaderAnnouncer);
            runTest('Skip Links', testSkipLinks);
            runTest('Focus Indicators', testFocusIndicators);
            runTest('Form Accessibility', testFormAccessibility);
            runTest('Status Indicator', testStatusIndicator);
            runTest('Theme Support', testThemeSupport);
            runTest('Announcement System', testAnnouncement);
            
            displayResults();
            log('Tests completed');
        });
        
        document.getElementById('clear-log').addEventListener('click', () => {
            testLog.textContent = '';
        });
        
        document.getElementById('theme-toggle').addEventListener('click', () => {
            if (window.EnhancedDarkModeManager) {
                window.EnhancedDarkModeManager.toggleTheme();
                log('Theme toggled');
            }
        });
        
        // Status change test
        let statusIndex = 0;
        const statuses = ['idle', 'pending', 'success', 'error'];
        document.getElementById('change-status').addEventListener('click', () => {
            const status = document.getElementById('test-status');
            const newStatus = statuses[statusIndex % statuses.length];
            
            status.className = 'status-indicator';
            status.classList.add(`status-${newStatus}`);
            status.setAttribute('aria-label', `Test status: ${newStatus}`);
            
            statusIndex++;
            log(`Status changed to: ${newStatus}`);
        });
        
        // Form test
        document.getElementById('test-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('test-input');
            if (input.value.trim()) {
                log('Form submitted successfully');
                if (window.AccessibilityManager) {
                    window.AccessibilityManager.announce('Form submitted successfully', 'polite');
                }
            } else {
                log('Form validation failed');
                if (window.AccessibilityManager) {
                    window.AccessibilityManager.announce('Please fill in the required field', 'assertive');
                }
            }
        });
        
        // Loading button test
        document.getElementById('loading-button').addEventListener('click', (e) => {
            const button = e.target;
            if (window.AccessibilityManager) {
                window.AccessibilityManager.updateButtonLoadingState(button, true, 'Loading...');
                
                setTimeout(() => {
                    window.AccessibilityManager.updateButtonLoadingState(button, false);
                    log('Loading state test completed');
                }, 2000);
            }
        });
        
        // Initial log
        log('Phase 4 Integration Test loaded');
        log('Click "Run All Tests" to start testing');
    </script>
</body>
</html>